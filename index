<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Courier Game - Demo</title>
  <!-- Leaflet CSS (doğrudan CDN) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{--topbar-h:56px;--bottombar-h:48px}
    html,body,#map{height:100%;margin:0;padding:0;font-family:Inter,system-ui,Arial}
    body{display:flex;flex-direction:column}
    .topbar{height:var(--topbar-h);display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:linear-gradient(90deg,#0f172a,#0b1220);color:#fff}
    .title{font-weight:700;font-size:18px}
    .status{display:flex;gap:12px;align-items:center}
    .badge{background:rgba(255,255,255,0.06);padding:6px 10px;border-radius:8px}
    .lives{font-size:18px}
    #map{flex:1}
    .bottombar{height:var(--bottombar-h);display:flex;align-items:center;justify-content:center;background:#0b1220;color:#e6eef8}
    .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:800;}
    .panel{background:rgba(11,18,32,0.92);padding:28px;border-radius:12px;color:#fff;box-shadow:0 8px 30px rgba(2,6,23,0.8);width:min(520px,90%);text-align:center}
    .large-btn{background:#06b6d4;border:none;padding:12px 20px;border-radius:8px;color:#042027;font-weight:700;font-size:18px;cursor:pointer}
    .hint{color:#cfeff7;margin-top:12px;font-size:14px}
    .small{font-size:14px;color:#cbd5e1}
    .heart{color:#ff6b6b;font-weight:700;margin-left:6px}
    .hud{position:absolute;top:var(--topbar-h);right:12px;z-index:700}
    .player-path{stroke:#06b6d4;stroke-width:3;fill:none}
    @media (max-width:520px){.title{font-size:16px}.large-btn{width:100%}}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="badge" id="timerBadge">TIME: <span id="timer">60</span>s</div>
    <div class="title">COURIER GAME</div>
    <div class="status">
      <div class="badge">SCORE: <span id="score">0</span></div>
      <div class="badge">LIVES: <span id="lives" class="lives">♥ ♥ ♥</span></div>
    </div>
  </div>

  <div id="map"></div>

  <div class="bottombar">The next delivery target will be displayed here</div>

  <!-- Start overlay -->
  <div class="overlay" id="startOverlay">
    <div class="panel">
      <h2>Courier Game</h2>
      <p class="small">Deliver as many packages as possible in 60 seconds. You have 3 lives — wrong clicks lose a life.</p>
      <button class="large-btn" id="startBtn">Play</button>
      <p class="hint">Click on the map to move your courier. Click inside the target circle to deliver.</p>
    </div>
  </div>

  <!-- Game over overlay -->
  <div class="overlay" id="gameOverOverlay" style="display:none;">
    <div class="panel">
      <h2>Game Over</h2>
      <p>Your final score: <strong id="finalScore">0</strong></p>
      <button class="large-btn" id="restartBtn">Play Again</button>
      <p class="hint">Tip: Try to click near the target. Radius and difficulty can be adjusted in code.</p>
    </div>
  </div>

  <!-- Leaflet JS (CDN) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Oyun script'i DOMContentLoaded içine alındı -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Config
      const GAME_TIME = 60;
      const START_LIVES = 3;
      const TARGET_RADIUS_METERS = 50;
      const difficultyStep = {afterDeliveries: 6, reduceBy: 10};

      // State
      let timer = GAME_TIME;
      let score = 0;
      let lives = START_LIVES;
      let playing = false;
      let intervalId = null;
      let currentTarget = null;
      let deliveryCount = 0;

      // Map setup (varsayılan NYC)
      const map = L.map('map', {zoomControl:true}).setView([40.7128, -74.0060], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
      }).addTo(map);

      // Layers
      const targetLayer = L.layerGroup().addTo(map);
      const playerLayer = L.layerGroup().addTo(map);
      const pathLayer = L.layerGroup().addTo(map);

      // Player marker
      let playerMarker = L.circleMarker(map.getCenter(), {radius:8, color:'#0284c7', fillColor:'#06b6d4', fillOpacity:1}).addTo(playerLayer);
      let playerLatLng = playerMarker.getLatLng();

      // Helpers
      function spawnRandomTarget() {
        targetLayer.clearLayers();
        const bounds = map.getBounds();
        const sw = bounds.getSouthWest();
        const ne = bounds.getNorthEast();
        const lat = Math.random() * (ne.lat - sw.lat) + sw.lat;
        const lng = Math.random() * (ne.lng - sw.lng) + sw.lng;
        currentTarget = {lat, lng, radius: TARGET_RADIUS_METERS};

        const circle = L.circle([lat, lng], {radius: currentTarget.radius, color:'#ef4444', fillColor:'#fb7185', fillOpacity:0.3}).addTo(targetLayer);
        const mark = L.marker([lat, lng], {title:'Delivery Target'}).addTo(targetLayer);

        document.querySelector('.bottombar').textContent = 'New target: approx at ' + lat.toFixed(4) + ', ' + lng.toFixed(4);
      }

      function updateUI(){
        document.getElementById('timer').textContent = timer;
        document.getElementById('score').textContent = score;
        // show hearts
        document.getElementById('lives').textContent = (lives > 0) ? '♥ '.repeat(lives).trim() : '';
      }

      function startTimer(){
        if(intervalId) clearInterval(intervalId);
        intervalId = setInterval(()=>{
          timer--;
          if(timer<=0){ timer=0; endGame(); }
          updateUI();
        },1000);
      }
      function stopTimer(){ if(intervalId) clearInterval(intervalId); intervalId = null; }

      function startGame(){
        timer = GAME_TIME; score = 0; lives = START_LIVES; playing=true; deliveryCount = 0;
        document.getElementById('startOverlay').style.display = 'none';
        document.getElementById('gameOverOverlay').style.display = 'none';
        spawnRandomTarget();
        updateUI();
        startTimer();
      }
      function endGame(){
        playing = false;
        stopTimer();
        document.getElementById('finalScore').textContent = score;
        document.getElementById('gameOverOverlay').style.display = 'flex';
      }

      function distanceMeters(a,b){ return map.distance(a,b); }

      map.on('click', function(e){
        if(!playing) return;
        const clickLatLng = e.latlng;
        if(currentTarget){
          const d = distanceMeters(clickLatLng, L.latLng(currentTarget.lat, currentTarget.lng));
          if(d <= currentTarget.radius){
            // success
            score++;
            deliveryCount++;
            animatePlayerTo(clickLatLng, ()=>{
              spawnRandomTarget();
              maybeIncreaseDifficulty();
              updateUI();
            });
            return;
          }
        }
        // wrong click
        lives--;
        updateUI();
        animatePlayerTo(clickLatLng);
        if(lives <= 0){ endGame(); }
      });

      function animatePlayerTo(destLatLng, cb){
        const start = playerMarker.getLatLng();
        const end = destLatLng;
        const steps = 30;
        let i = 0;
        const latStep = (end.lat - start.lat) / steps;
        const lngStep = (end.lng - start.lng) / steps;
        const pathCoords = [start];
        const anim = setInterval(()=>{
          i++;
          const next = L.latLng(start.lat + latStep*i, start.lng + lngStep*i);
          playerMarker.setLatLng(next);
          pathCoords.push(next);
          if(i >= steps){
            clearInterval(anim);
            playerLatLng = next;
            drawPath(pathCoords);
            if(cb) cb();
          }
        }, 12);
      }

      function drawPath(coords){
        pathLayer.clearLayers();
        L.polyline(coords, {color:'#06b6d4', weight:3, opacity:0.9}).addTo(pathLayer);
        setTimeout(()=>{ pathLayer.clearLayers(); }, 3000);
      }

      function maybeIncreaseDifficulty(){
        if(difficultyStep.afterDeliveries > 0 && (deliveryCount % difficultyStep.afterDeliveries) === 0){
          const newRadius = Math.max(15, (currentTarget && currentTarget.radius ? currentTarget.radius : TARGET_RADIUS_METERS) - difficultyStep.reduceBy);
          if(currentTarget) currentTarget.radius = newRadius;
          // redraw circle to reflect change
          spawnRandomTarget();
        }
      }

      // Controls
      document.getElementById('startBtn').addEventListener('click', ()=>{ startGame(); });
      document.getElementById('restartBtn').addEventListener('click', ()=>{ startGame(); });

      updateUI();

      // Optional: get geolocation if user allows
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(function(pos){
          const lat = pos.coords.latitude, lng = pos.coords.longitude;
          playerMarker.setLatLng([lat,lng]);
          map.setView([lat,lng], 14);
        }, ()=>{/* silent */});
      }

      // Debug keys
      window.addEventListener('keydown', (e)=>{
        if(e.key === 'g'){ spawnRandomTarget(); }
        if(e.key === 'r'){ stopTimer(); timer = GAME_TIME; score = 0; lives = START_LIVES; updateUI(); }
      });
    }); // DOMContentLoaded end
  </script>
</body>
</html>
